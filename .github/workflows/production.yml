name: Production Deployment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Digital Ocean Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ Starting Deployment..."
            cd /opt/apps/base2
            
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ğŸ—ï¸ Building and Restarting Services..."
            # Using local.docker.yml as the production config (per current setup)
            docker compose -f local.docker.yml up -d --build --remove-orphans
            
            echo "ğŸ§¹ Pruning unused images..."
            docker image prune -f
            
            echo "âœ… Deployment Command Sent."

      - name: Verify Health Check
        run: |
            echo "Waiting for services to stabilize..."
            sleep 30
            echo "Checking API Health..."
            curl -f --retry 5 --retry-delay 5 https://losricostacos.com/api/health
            echo "Checking Frontend..."
            curl -f --retry 5 --retry-delay 5 https://losricostacos.com
            echo "ğŸ‰ Verification Successful!"
